# Set environment variables
ENV POSTGRES_VERSION=13
ENV PGDATA=/var/lib/pgsql/data

# Install PostgreSQL
RUN dnf -y update && \
    dnf -y install dnf-plugins-core && \
    dnf -y module enable postgresql:$POSTGRES_VERSION && \
    dnf -y install postgresql-server postgresql-contrib && \
    dnf clean all

# Allow dynamic UID and GID
ARG UID=1000
ARG GID=1000

# Update postgres group and user with provided UID and GID
# Dynamically update the postgres group and user if necessary
RUN if [ "$(getent group postgres | cut -d: -f3)" != "$GID" ]; then groupmod -g $GID postgres; fi && \
    if [ "$(id -u postgres)" != "$UID" ]; then usermod -u $UID postgres; fi && \
    chown -R postgres:postgres /var/lib/pgsql

# Ensure the data directory exists and has correct permissions
RUN mkdir -p $PGDATA && \
    chown -R postgres:postgres $PGDATA && \
    chmod 700 $PGDATA

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expose PostgreSQL port
EXPOSE 5432

# Switch to postgres user
USER postgres

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Default command
CMD ["postgres", "-D", "/var/lib/pgsql/data"]
