FROM almalinux:8

# Set environment variables
ENV POSTGRES_VERSION=13
ENV PGDATA=/var/lib/pgsql/data

# Install PostgreSQL
RUN dnf -y update && \
    dnf -y install dnf-plugins-core && \
    dnf -y module enable postgresql:${POSTGRES_VERSION} && \
    dnf -y install postgresql-server postgresql-contrib && \
    dnf clean all

# Allow dynamic UID and GID
ARG UID=1000
ARG GID=1000

# Update the postgres group and user
RUN groupmod -g $GID postgres || true && \
    usermod -u $UID postgres || true

# Copy your entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expose PostgreSQL port
EXPOSE 5432

# Keep user as root here, so we can chown inside the entrypoint
USER root

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["postgres", "-D", "/var/lib/pgsql/data"]
