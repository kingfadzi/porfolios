FROM almalinux:8

# Set environment variables
ENV POSTGRES_VERSION=13
ENV PGDATA=/var/lib/pgsql/data

# Accept UID and GID as build arguments
ARG USER_ID=1000
ARG GROUP_ID=1000

# Install PostgreSQL
RUN dnf -y update && \
    dnf -y install dnf-plugins-core && \
    dnf -y module enable postgresql:${POSTGRES_VERSION} && \
    dnf -y install postgresql-server postgresql-contrib && \
    dnf clean all

# Create a group and user with the provided GID and UID
RUN groupadd -g ${GROUP_ID} pggroup && \
    useradd -u ${USER_ID} -g pggroup -m pguser

# Set up the data directory
RUN mkdir -p ${PGDATA} && chown -R pguser:pggroup ${PGDATA}

# Copy your entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expose PostgreSQL port
EXPOSE 5432

# Switch to pguser
USER pguser

# Initialize the database
RUN /usr/bin/postgresql-setup initdb

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["postgres", "-D", "${PGDATA}"]
