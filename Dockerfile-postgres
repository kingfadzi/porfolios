FROM almalinux:8

# Set environment variables
ENV POSTGRES_VERSION=13
ENV PGDATA=/var/lib/pgsql/data

# Install PostgreSQL
RUN dnf -y update && \
dnf -y install \
dnf-plugins-core && \
dnf -y module enable postgresql:$POSTGRES_VERSION && \
dnf -y install \
postgresql-server \
postgresql-contrib && \
dnf clean all

# Allow dynamic UID and GID
ARG UID=1000
ARG GID=1000

# Create postgres group and user with dynamic UID/GID
RUN groupadd -g $GID postgres && \
    useradd -u $UID -g $GID -m -s /bin/bash postgres && \
    chmod 700 $PGDATA

# Initialize PostgreSQL
RUN mkdir -p $PGDATA && chown -R postgres:postgres $PGDATA && \
su - postgres -c "initdb -D $PGDATA"

# Configure PostgreSQL for external connections
RUN echo "listen_addresses = '*'" >> $PGDATA/postgresql.conf && \
echo "host all all 0.0.0.0/0 md5" >> $PGDATA/pg_hba.conf

# Copy initialization script
COPY postgres-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expose PostgreSQL port
EXPOSE 5432

# Run PostgreSQL
USER postgres

# Set entrypoint script
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

CMD ["postgres", "-D", "/var/lib/pgsql/data"]
